# Rolling Deployment æµ‹è¯•æ–¹æ¡ˆ

## ä¿®æ”¹å†…å®¹æ€»ç»“

### 1. åˆ†å¸ƒå¼é”æœºåˆ¶
- âœ… ä½¿ç”¨ `sxt:consumer_lock` é”ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹ç›‘å¬ Redis PubSub
- âœ… é”æ¯30ç§’è¿‡æœŸï¼Œæ¯15ç§’ç»­æœŸ
- âœ… æ–°å®ä¾‹å¯åŠ¨æ—¶ä¼šç­‰å¾…è·å–é”

### 2. å®ä¾‹æ³¨å†Œæœºåˆ¶
- âœ… æ¯ä¸ªå®ä¾‹æœ‰å”¯ä¸€ID: `instance-{pid}-{timestamp}`
- âœ… å®ä¾‹ä¿¡æ¯å­˜å‚¨åœ¨ `sxt:instances:{instance_id}`ï¼Œ60ç§’è¿‡æœŸ
- âœ… å®ä¾‹å…³é—­æ—¶è‡ªåŠ¨æ³¨é”€

### 3. Listener æ‰€æœ‰æƒæœºåˆ¶
- âœ… ä½¿ç”¨ `sxt:listener_owners` Hash å­˜å‚¨ listener_id â†’ instance_id æ˜ å°„
- âœ… å¯åŠ¨ listener æ—¶æ ‡è®°æ‰€æœ‰æƒ
- âœ… åœæ­¢ listener æ—¶é‡Šæ”¾æ‰€æœ‰æƒ
- âœ… åªæœ‰æ‰€æœ‰è€…å¯ä»¥åœæ­¢è‡ªå·±çš„ listener

### 4. æ¥ç®¡æœºåˆ¶
- âœ… æ–°å®ä¾‹è·å¾—é”åï¼Œæ£€æŸ¥æ‰€æœ‰ listeners çš„æ‰€æœ‰æƒ
- âœ… å¦‚æœåŸæ‰€æœ‰è€…å·²å¤±æ•ˆï¼ˆå®ä¾‹IDä¸å­˜åœ¨ï¼‰ï¼Œæ–°å®ä¾‹æ¥ç®¡
- âœ… é¿å…é‡å¤å¯åŠ¨ç›¸åŒçš„ listener

## Rolling Deployment æµç¨‹

### é˜¶æ®µ1ï¼šæ—§å®¹å™¨è¿è¡Œä¸­
````
æ—§å®¹å™¨ (instance-old):
- âœ… æŒæœ‰ consumer_lock
- âœ… ç›‘å¬ listenerCommandChannel
- âœ… è¿è¡Œ listener1, listener2, listener3
- âœ… listener_owners: {listener1: instance-old, ...}
````

### é˜¶æ®µ2ï¼šæ–°å®¹å™¨å¯åŠ¨
````
æ–°å®¹å™¨ (instance-new) å¯åŠ¨:
1. ç”Ÿæˆå®ä¾‹ID: instance-new
2. æ³¨å†Œå®ä¾‹: sxt:instances:instance-new
3. å°è¯•è·å– consumer_lock
   â†’ å¤±è´¥ï¼ˆè¢« instance-old æŒæœ‰ï¼‰
4. æ¯5ç§’é‡è¯•è·å–é”
   â³ ç­‰å¾…ä¸­...
````

### é˜¶æ®µ3ï¼šæ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡
````
Railway å¥åº·æ£€æŸ¥:
- GET / â†’ 200 OK âœ…
- æ–°å®¹å™¨æ ‡è®°ä¸º healthy
- Railway å‡†å¤‡åˆ‡æ¢æµé‡
````

### é˜¶æ®µ4ï¼šRailway åœæ­¢æ—§å®¹å™¨
````
æ—§å®¹å™¨æ”¶åˆ° SIGTERM:
1. stop_listening() è¢«è°ƒç”¨
2. self.running = False
3. PubSub å¾ªç¯é€€å‡º
4. finally å—æ‰§è¡Œ:
   - é‡Šæ”¾ consumer_lock âœ…
   - å…³é—­ PubSub è¿æ¥
   - æ³¨é”€å®ä¾‹: åˆ é™¤ sxt:instances:instance-old
   - é‡Šæ”¾æ‰€æœ‰ listeners çš„æ‰€æœ‰æƒ
5. å®¹å™¨å…³é—­
````

### é˜¶æ®µ5ï¼šæ–°å®¹å™¨æ¥ç®¡
````
æ–°å®¹å™¨ (instance-new):
1. æ£€æµ‹åˆ° consumer_lock å¯ç”¨
2. è·å–é”æˆåŠŸ âœ…
3. å¯åŠ¨é”ç»­æœŸä»»åŠ¡
4. è°ƒç”¨ _takeover_listeners():
   - è¯»å– sxt:tokens ä¸­çš„æ‰€æœ‰ listeners
   - æ£€æŸ¥æ¯ä¸ª listener çš„æ‰€æœ‰è€…
   - listener1 çš„æ‰€æœ‰è€…æ˜¯ instance-old
   - æ£€æŸ¥ sxt:instances:instance-old â†’ ä¸å­˜åœ¨ âœ…
   - æ¥ç®¡ listener1ï¼Œå¯åŠ¨ WebSocket è¿æ¥
   - æ ‡è®°æ‰€æœ‰æƒ: listener_owners[listener1] = instance-new
   - é‡å¤ listener2, listener3...
5. è®¢é˜… listenerCommandChannel
6. å¼€å§‹æ­£å¸¸ç›‘å¬

âœ… å¹³æ»‘è¿‡æ¸¡å®Œæˆï¼
````

## é¿å…çš„å†²çª

### 1. âœ… Redis PubSub é‡å¤è®¢é˜…
**é—®é¢˜**ï¼šæ–°æ—§å®¹å™¨åŒæ—¶è®¢é˜…ï¼Œå‘½ä»¤è¢«æ‰§è¡Œä¸¤æ¬¡
**è§£å†³**ï¼šåˆ†å¸ƒå¼é”ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æŒæœ‰ç›‘å¬æƒé™

### 2. âœ… Listener é‡å¤å¯åŠ¨
**é—®é¢˜**ï¼šæ–°æ—§å®¹å™¨åŒæ—¶è¿è¡Œç›¸åŒçš„ listener_id
**è§£å†³**ï¼šæ‰€æœ‰æƒæœºåˆ¶ï¼Œå¯åŠ¨å‰æ£€æŸ¥æ‰€æœ‰è€…æ˜¯å¦å­˜æ´»

### 3. âœ… WebSocket è¿æ¥å†²çª
**é—®é¢˜**ï¼šä¸¤ä¸ªå®¹å™¨åŒæ—¶è¿æ¥å°çº¢ä¹¦
**è§£å†³**ï¼šæ¥ç®¡æœºåˆ¶ç¡®ä¿æ—§å®¹å™¨å…³é—­åæ‰å¯åŠ¨æ–°è¿æ¥

### 4. âœ… Redis çŠ¶æ€ç«äº‰
**é—®é¢˜**ï¼šæ–°æ—§å®¹å™¨åŒæ—¶å†™å…¥çŠ¶æ€
**è§£å†³**ï¼šæ‰€æœ‰æƒæ ‡è®°ï¼Œåªæœ‰æ‰€æœ‰è€…å¯ä»¥ä¿®æ”¹çŠ¶æ€

## å…¼å®¹æ€§ä¿è¯

### å¯¹è€ä»£ç çš„å…¼å®¹
1. **æ—§å®¹å™¨å…³é—­æ—¶**ï¼š
   - å³ä½¿æ²¡æœ‰ `_unregister_instance()`ï¼Œ60ç§’åå®ä¾‹è®°å½•è‡ªåŠ¨è¿‡æœŸ
   - æ–°å®¹å™¨ä¼šåœ¨60ç§’åæ¥ç®¡

2. **æ—§å®¹å™¨æŒæœ‰çš„ listeners**ï¼š
   - æ–°å®¹å™¨æ£€æµ‹åˆ°æ‰€æœ‰è€…å®ä¾‹ä¸å­˜åœ¨ â†’ è‡ªåŠ¨æ¥ç®¡
   - ä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„

3. **é€æ­¥å‡çº§**ï¼š
   - ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼šæ–°ä»£ç å®¹å™¨å¯åŠ¨ï¼Œæ—§ä»£ç å®¹å™¨å…³é—­
   - æ–°å®¹å™¨ç­‰å¾…60ç§’åæ¥ç®¡ï¼ˆå› ä¸ºæ—§å®¹å™¨æ²¡æœ‰æ³¨é”€å®ä¾‹ï¼‰
   - ç¬¬äºŒæ¬¡éƒ¨ç½²ï¼šæ–°â†’æ–°ï¼Œå¹³æ»‘è¿‡æ¸¡ï¼ˆå› ä¸ºéƒ½æœ‰æ³¨é”€é€»è¾‘ï¼‰

## æµ‹è¯•æ­¥éª¤

### 1. éƒ¨ç½²æ–°ä»£ç 
````bash
git add message_queue.py
git commit -m "Add distributed lock and ownership mechanism for rolling deployment"
git push
````

### 2. ç›‘æ§æ—¥å¿—
````bash
railway logs --follow
````

### 3. é¢„æœŸæ—¥å¿—è¾“å‡º

**æ–°å®¹å™¨å¯åŠ¨**ï¼š
````
ğŸ†” å®ä¾‹ID: instance-123456-789
âœ… å®ä¾‹ instance-123456-789 å·²æ³¨å†Œ
â³ å®ä¾‹ instance-123456-789 ç­‰å¾…ç›‘å¬æƒé™ï¼Œå½“å‰æŒæœ‰è€…: instance-old-111
â³ å®ä¾‹ instance-123456-789 ç­‰å¾…ç›‘å¬æƒé™ï¼Œå½“å‰æŒæœ‰è€…: instance-old-111
...ï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
````

**æ—§å®¹å™¨å…³é—­**ï¼š
````
ğŸ›‘ åœæ­¢ç›‘å¬ (å®ä¾‹ instance-old-111)
ğŸ”“ å®ä¾‹ instance-old-111 é‡Šæ”¾ç›‘å¬é”
âœ… é‡Šæ”¾äº† 3 ä¸ª listeners çš„æ‰€æœ‰æƒ
âœ… å®ä¾‹ instance-old-111 å·²æ³¨é”€
ğŸ ç›‘å¬å™¨å·²å®Œå…¨åœæ­¢
````

**æ–°å®¹å™¨æ¥ç®¡**ï¼š
````
âœ… å®ä¾‹ instance-123456-789 è·å¾—ç›‘å¬æƒé™
ğŸ”„ å®ä¾‹ instance-123456-789 å¼€å§‹æ¥ç®¡ listeners...
ğŸ”„ Listener listener1 çš„åŸæ‰€æœ‰è€… instance-old-111 å·²å¤±æ•ˆï¼Œæ¥ç®¡
ğŸš€ æ¥ç®¡ Listener listener1...
[Connecting] ğŸ” ä½¿ç”¨ä»£ç†è¿æ¥...
[Connected] âœ… WebSocketè¿æ¥å·²å»ºç«‹
âœ… æˆåŠŸæ¥ç®¡ Listener listener1
ğŸ”„ Listener listener2 çš„åŸæ‰€æœ‰è€… instance-old-111 å·²å¤±æ•ˆï¼Œæ¥ç®¡
...
ğŸ‰ æ¥ç®¡å®Œæˆï¼Œå½“å‰è¿è¡Œ 3 ä¸ª listeners
ğŸ”— å®ä¾‹ instance-123456-789 å·²è®¢é˜…é¢‘é“
````

## å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°ä»£ç æœ‰é—®é¢˜ï¼Œå›æ»šåˆ°æ—§ä»£ç ï¼š

````bash
# 1. å›æ»š Git
git revert HEAD
git push

# 2. Railway ä¼šéƒ¨ç½²æ—§ä»£ç 
# 3. æ—§ä»£ç å®¹å™¨å¯åŠ¨ï¼Œä½†æ²¡æœ‰åˆ†å¸ƒå¼é”é€»è¾‘
# 4. æ–°ä»£ç å®¹å™¨å…³é—­æ—¶é‡Šæ”¾é”
# 5. æ—§ä»£ç å®¹å™¨ç›´æ¥ç›‘å¬ï¼ˆæ²¡æœ‰é”æ£€æŸ¥ï¼‰
# 6. æ­£å¸¸è¿è¡Œ âœ…
````

## ç›‘æ§æŒ‡æ ‡

### éƒ¨ç½²æˆåŠŸæŒ‡æ ‡ï¼š
- âœ… æ–°å®¹å™¨è·å¾— consumer_lock
- âœ… æ‰€æœ‰ listeners è¢«æ¥ç®¡
- âœ… WebSocket è¿æ¥å»ºç«‹æˆåŠŸ
- âœ… æ²¡æœ‰é‡å¤æ¶ˆæ¯

### éƒ¨ç½²å¤±è´¥æŒ‡æ ‡ï¼š
- âŒ æ–°å®¹å™¨ä¸€ç›´åœ¨ç­‰å¾…é”ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
- âŒ Listeners æ¥ç®¡å¤±è´¥
- âŒ WebSocket è¿æ¥è¶…æ—¶

## ç´§æ€¥å¤„ç†

### å¦‚æœæ–°æ—§å®¹å™¨éƒ½å¡ä½ï¼š
````bash
# æ‰‹åŠ¨é‡Šæ”¾é”
redis-cli -h your-redis DEL sxt:consumer_lock

# æ¸…ç†æ‰€æœ‰å®ä¾‹è®°å½•
redis-cli -h your-redis --scan --pattern "sxt:instances:*" | xargs redis-cli DEL

# æ¸…ç†æ‰€æœ‰è€…è®°å½•
redis-cli -h your-redis DEL sxt:listener_owners
````

### å¦‚æœéœ€è¦å¼ºåˆ¶é‡å¯æ‰€æœ‰ listenersï¼š
````bash
# é€šè¿‡ API å‘é€ recover å‘½ä»¤
curl -X POST https://your-app.railway.app/admin/command \
  -H "Content-Type: application/json" \
  -d '{"command": "recover"}'
````
